-- AR Navigation v2 â€” Production Supabase Schema
-- Run this SQL in your Supabase SQL Editor
-- WARNING: This will drop existing tables. Back up data first.

-- ============================================================
-- 1. FLOORS
-- ============================================================
CREATE TABLE IF NOT EXISTS floors (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  name TEXT NOT NULL,
  level_number INT NOT NULL DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT now()
);

ALTER TABLE floors ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Allow public read floors" ON floors FOR SELECT USING (true);

-- ============================================================
-- 2. NAVIGATION NODES
-- ============================================================
CREATE TABLE IF NOT EXISTS navigation_nodes (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  x FLOAT NOT NULL,
  z FLOAT NOT NULL,
  floor_id UUID REFERENCES floors(id) ON DELETE CASCADE,
  walkable BOOLEAN NOT NULL DEFAULT true,
  label TEXT,
  created_at TIMESTAMPTZ DEFAULT now()
);

ALTER TABLE navigation_nodes ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Allow public read nodes" ON navigation_nodes FOR SELECT USING (true);

-- ============================================================
-- 3. NAVIGATION EDGES
-- ============================================================
CREATE TABLE IF NOT EXISTS navigation_edges (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  from_node UUID NOT NULL REFERENCES navigation_nodes(id) ON DELETE CASCADE,
  to_node UUID NOT NULL REFERENCES navigation_nodes(id) ON DELETE CASCADE,
  distance FLOAT,
  created_at TIMESTAMPTZ DEFAULT now(),
  CONSTRAINT different_nodes CHECK (from_node != to_node)
);

ALTER TABLE navigation_edges ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Allow public read edges" ON navigation_edges FOR SELECT USING (true);

-- Auto-calculate distance on insert/update
CREATE OR REPLACE FUNCTION calculate_edge_distance()
RETURNS TRIGGER AS $$
DECLARE
  from_x FLOAT;
  from_z FLOAT;
  to_x FLOAT;
  to_z FLOAT;
BEGIN
  SELECT x, z INTO from_x, from_z FROM navigation_nodes WHERE id = NEW.from_node;
  SELECT x, z INTO to_x, to_z FROM navigation_nodes WHERE id = NEW.to_node;
  NEW.distance := sqrt(power(to_x - from_x, 2) + power(to_z - from_z, 2));
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_calc_edge_distance
  BEFORE INSERT OR UPDATE ON navigation_edges
  FOR EACH ROW
  EXECUTE FUNCTION calculate_edge_distance();

-- ============================================================
-- 4. SECTIONS (updated â€” references navigation_nodes)
-- ============================================================
-- Drop old sections table if it exists
DROP TABLE IF EXISTS sections CASCADE;

CREATE TABLE sections (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  name TEXT NOT NULL,
  node_id UUID NOT NULL REFERENCES navigation_nodes(id) ON DELETE CASCADE,
  icon TEXT,
  created_at TIMESTAMPTZ DEFAULT now()
);

ALTER TABLE sections ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Allow public read sections" ON sections FOR SELECT USING (true);

-- ============================================================
-- 5. SEED DATA â€” Realistic store layout
-- ============================================================

-- Floor
INSERT INTO floors (id, name, level_number) VALUES
  ('10000000-0000-0000-0000-000000000001', 'Ground Floor', 0);

-- Navigation Nodes (positions in meters from entrance at 0,0)
-- Entrance area
INSERT INTO navigation_nodes (id, x, z, floor_id, walkable, label) VALUES
  ('00000000-0000-0000-0000-000000000001', 0,    0,    '10000000-0000-0000-0000-000000000001', true, 'Entrance'),
  ('00000000-0000-0000-0000-000000000002', 0,    3,    '10000000-0000-0000-0000-000000000001', true, 'Main Aisle Start');

-- Main corridor (runs along z-axis)
INSERT INTO navigation_nodes (id, x, z, floor_id, walkable, label) VALUES
  ('00000000-0000-0000-0000-000000000003', 0,    6,    '10000000-0000-0000-0000-000000000001', true, 'Main Junction 1'),
  ('00000000-0000-0000-0000-000000000004', 0,    10,   '10000000-0000-0000-0000-000000000001', true, 'Main Junction 2'),
  ('00000000-0000-0000-0000-000000000005', 0,    14,   '10000000-0000-0000-0000-000000000001', true, 'Back Wall Center');

-- Left wing (negative x)
INSERT INTO navigation_nodes (id, x, z, floor_id, walkable, label) VALUES
  ('00000000-0000-0000-0000-000000000006', -4,   6,    '10000000-0000-0000-0000-000000000001', true, 'Left Aisle 1'),
  ('00000000-0000-0000-0000-000000000007', -8,   6,    '10000000-0000-0000-0000-000000000001', true, 'Groceries Section'),
  ('00000000-0000-0000-0000-000000000008', -4,   10,   '10000000-0000-0000-0000-000000000001', true, 'Left Aisle 2'),
  ('00000000-0000-0000-0000-000000000009', -8,   10,   '10000000-0000-0000-0000-000000000001', true, 'Fresh Produce');

-- Right wing (positive x)
INSERT INTO navigation_nodes (id, x, z, floor_id, walkable, label) VALUES
  ('00000000-0000-0000-0000-000000000010', 4,    6,    '10000000-0000-0000-0000-000000000001', true, 'Right Aisle 1'),
  ('00000000-0000-0000-0000-000000000011', 8,    6,    '10000000-0000-0000-0000-000000000001', true, 'Electronics Section'),
  ('00000000-0000-0000-0000-000000000012', 4,    10,   '10000000-0000-0000-0000-000000000001', true, 'Right Aisle 2'),
  ('00000000-0000-0000-0000-000000000013', 8,    10,   '10000000-0000-0000-0000-000000000001', true, 'Clothing Section');

-- Back area
INSERT INTO navigation_nodes (id, x, z, floor_id, walkable, label) VALUES
  ('00000000-0000-0000-0000-000000000014', -4,   14,   '10000000-0000-0000-0000-000000000001', true, 'Back Left'),
  ('00000000-0000-0000-0000-000000000015', 4,    14,   '10000000-0000-0000-0000-000000000001', true, 'Back Right');

-- Billing area (near entrance)
INSERT INTO navigation_nodes (id, x, z, floor_id, walkable, label) VALUES
  ('00000000-0000-0000-0000-000000000016', 4,    2,    '10000000-0000-0000-0000-000000000001', true, 'Billing Section');

-- Additional corridor nodes for smoother paths
INSERT INTO navigation_nodes (id, x, z, floor_id, walkable, label) VALUES
  ('00000000-0000-0000-0000-000000000017', 4,    3,    '10000000-0000-0000-0000-000000000001', true, 'Right Near Entrance'),
  ('00000000-0000-0000-0000-000000000018', -4,   3,    '10000000-0000-0000-0000-000000000001', true, 'Left Near Entrance');

-- Navigation Edges (bidirectional â€” insert both directions)
-- Entrance corridor
INSERT INTO navigation_edges (from_node, to_node) VALUES
  ('00000000-0000-0000-0000-000000000001', '00000000-0000-0000-0000-000000000002'),
  ('00000000-0000-0000-0000-000000000002', '00000000-0000-0000-0000-000000000001');

-- Main corridor
INSERT INTO navigation_edges (from_node, to_node) VALUES
  ('00000000-0000-0000-0000-000000000002', '00000000-0000-0000-0000-000000000003'),
  ('00000000-0000-0000-0000-000000000003', '00000000-0000-0000-0000-000000000002'),
  ('00000000-0000-0000-0000-000000000003', '00000000-0000-0000-0000-000000000004'),
  ('00000000-0000-0000-0000-000000000004', '00000000-0000-0000-0000-000000000003'),
  ('00000000-0000-0000-0000-000000000004', '00000000-0000-0000-0000-000000000005'),
  ('00000000-0000-0000-0000-000000000005', '00000000-0000-0000-0000-000000000004');

-- Left wing from junctions
INSERT INTO navigation_edges (from_node, to_node) VALUES
  ('00000000-0000-0000-0000-000000000003', '00000000-0000-0000-0000-000000000006'),
  ('00000000-0000-0000-0000-000000000006', '00000000-0000-0000-0000-000000000003'),
  ('00000000-0000-0000-0000-000000000006', '00000000-0000-0000-0000-000000000007'),
  ('00000000-0000-0000-0000-000000000007', '00000000-0000-0000-0000-000000000006'),
  ('00000000-0000-0000-0000-000000000004', '00000000-0000-0000-0000-000000000008'),
  ('00000000-0000-0000-0000-000000000008', '00000000-0000-0000-0000-000000000004'),
  ('00000000-0000-0000-0000-000000000008', '00000000-0000-0000-0000-000000000009'),
  ('00000000-0000-0000-0000-000000000009', '00000000-0000-0000-0000-000000000008'),
  ('00000000-0000-0000-0000-000000000006', '00000000-0000-0000-0000-000000000008'),
  ('00000000-0000-0000-0000-000000000008', '00000000-0000-0000-0000-000000000006'),
  ('00000000-0000-0000-0000-000000000007', '00000000-0000-0000-0000-000000000009'),
  ('00000000-0000-0000-0000-000000000009', '00000000-0000-0000-0000-000000000007');

-- Right wing from junctions
INSERT INTO navigation_edges (from_node, to_node) VALUES
  ('00000000-0000-0000-0000-000000000003', '00000000-0000-0000-0000-000000000010'),
  ('00000000-0000-0000-0000-000000000010', '00000000-0000-0000-0000-000000000003'),
  ('00000000-0000-0000-0000-000000000010', '00000000-0000-0000-0000-000000000011'),
  ('00000000-0000-0000-0000-000000000011', '00000000-0000-0000-0000-000000000010'),
  ('00000000-0000-0000-0000-000000000004', '00000000-0000-0000-0000-000000000012'),
  ('00000000-0000-0000-0000-000000000012', '00000000-0000-0000-0000-000000000004'),
  ('00000000-0000-0000-0000-000000000012', '00000000-0000-0000-0000-000000000013'),
  ('00000000-0000-0000-0000-000000000013', '00000000-0000-0000-0000-000000000012'),
  ('00000000-0000-0000-0000-000000000010', '00000000-0000-0000-0000-000000000012'),
  ('00000000-0000-0000-0000-000000000012', '00000000-0000-0000-0000-000000000010'),
  ('00000000-0000-0000-0000-000000000011', '00000000-0000-0000-0000-000000000013'),
  ('00000000-0000-0000-0000-000000000013', '00000000-0000-0000-0000-000000000011');

-- Back area connections
INSERT INTO navigation_edges (from_node, to_node) VALUES
  ('00000000-0000-0000-0000-000000000005', '00000000-0000-0000-0000-000000000014'),
  ('00000000-0000-0000-0000-000000000014', '00000000-0000-0000-0000-000000000005'),
  ('00000000-0000-0000-0000-000000000005', '00000000-0000-0000-0000-000000000015'),
  ('00000000-0000-0000-0000-000000000015', '00000000-0000-0000-0000-000000000005'),
  ('00000000-0000-0000-0000-000000000008', '00000000-0000-0000-0000-000000000014'),
  ('00000000-0000-0000-0000-000000000014', '00000000-0000-0000-0000-000000000008'),
  ('00000000-0000-0000-0000-000000000012', '00000000-0000-0000-0000-000000000015'),
  ('00000000-0000-0000-0000-000000000015', '00000000-0000-0000-0000-000000000012');

-- Near entrance lateral connections
INSERT INTO navigation_edges (from_node, to_node) VALUES
  ('00000000-0000-0000-0000-000000000002', '00000000-0000-0000-0000-000000000017'),
  ('00000000-0000-0000-0000-000000000017', '00000000-0000-0000-0000-000000000002'),
  ('00000000-0000-0000-0000-000000000017', '00000000-0000-0000-0000-000000000016'),
  ('00000000-0000-0000-0000-000000000016', '00000000-0000-0000-0000-000000000017'),
  ('00000000-0000-0000-0000-000000000002', '00000000-0000-0000-0000-000000000018'),
  ('00000000-0000-0000-0000-000000000018', '00000000-0000-0000-0000-000000000002');

-- Sections (mapped to specific nodes)
INSERT INTO sections (name, node_id, icon) VALUES
  ('Billing',      '00000000-0000-0000-0000-000000000016', 'ðŸ’³'),
  ('Electronics',  '00000000-0000-0000-0000-000000000011', 'ðŸ“±'),
  ('Groceries',    '00000000-0000-0000-0000-000000000007', 'ðŸ›’'),
  ('Clothing',     '00000000-0000-0000-0000-000000000013', 'ðŸ‘•');
